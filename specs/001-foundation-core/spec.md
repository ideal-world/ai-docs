# Feature Specification: 平台基础架构与核心能力

**Feature Branch**: `001-foundation-core`  
**Created**: 2025-11-06  
**Status**: Draft  
**Input**: User description: "参考readme.md的功能清单要求,先帮我规划一下基础能力,实现骨架能力及基础能力,做为后续各功能迭代的核心及基础。"

## User Scenarios & Testing _(mandatory)_

### User Story 1 - 项目骨架与开发环境搭建 (Priority: P1)

作为开发者,我需要建立项目的基础架构,包括前端框架、构建工具、开发环境配置,以便后续功能开发能够顺利进行。

**Why this priority**: 这是整个项目的基石。没有基础架构,任何功能都无法开发。必须首先完成才能进行后续任何开发工作。

**Independent Test**: 可通过以下方式独立测试:启动开发服务器,访问默认页面,验证 i18n 切换功能,确认构建流程能够成功打包,所有依赖正确安装。

**Acceptance Scenarios**:

1. **Given** 开发者克隆代码仓库, **When** 执行 `pnpm install` 和 `pnpm dev`, **Then** 开发服务器在指定端口成功启动,浏览器可以访问默认页面
2. **Given** 应用已启动, **When** 切换语言选项(中文/英文), **Then** 界面文本立即切换为对应语言,且刷新后保持选择
3. **Given** 开发者修改源代码, **When** 保存文件, **Then** 页面自动热更新,反映最新变更
4. **Given** 开发完成, **When** 执行 `pnpm build`, **Then** 成功生成生产环境构建产物,无错误或警告
5. **Given** Tailwind 样式类在组件中使用, **When** 编译, **Then** 样式正确应用,未使用的样式被自动清除

---

### User Story 2 - 基础组件库与布局系统 (Priority: P1)

作为开发者,我需要可复用的基础 UI 组件和响应式布局系统,以便快速构建统一风格的用户界面。

**Why this priority**: 基础组件是所有功能界面的构建块。统一的组件库确保界面一致性,避免重复开发,是核心功能开发的前置依赖。

**Independent Test**: 可通过以下方式独立测试:创建组件展示页面,展示所有基础组件的不同状态和变体,验证响应式布局在不同屏幕尺寸下的表现,测试组件的交互功能。

**Acceptance Scenarios**:

1. **Given** 主工作台页面加载, **When** 页面渲染, **Then** 显示左右分栏布局,左侧进一步分为上下两栏,分栏比例合理
2. **Given** 鼠标悬停在分栏分隔线上, **When** 拖拽分隔线, **Then** 分栏尺寸实时调整,松开后保持新尺寸
3. **Given** 使用按钮组件, **When** 传入不同属性(主要、次要、危险、禁用), **Then** 按钮显示对应样式和交互行为
4. **Given** 使用卡片组件, **When** 传入标题、内容、操作按钮, **Then** 卡片正确渲染所有区域,支持展开/折叠
5. **Given** 使用进度条组件, **When** 传入进度值(0-100), **Then** 进度条动画更新到对应百分比,显示百分比文本
6. **Given** 窗口尺寸调整到移动设备宽度, **When** 页面重新渲染, **Then** 布局切换为堆叠式,保持可用性

---

### User Story 3 - 文件上传与预览核心能力 (Priority: P1)

作为用户,我需要上传主文档(图片/PDF/Office)并预览,以便在系统中处理文档内容。

**Why this priority**: 文档上传和预览是所有 AI 处理功能的入口。没有这个能力,用户无法将文档导入系统,后续所有功能都无法使用。

**Independent Test**: 可通过以下方式独立测试:选择不同格式的文件(jpg、png、pdf、docx)上传,验证上传进度显示,确认文件上传成功后能在预览区正确显示,测试大文件上传和异常处理。

**Acceptance Scenarios**:

1. **Given** 用户在主工作台, **When** 点击上传按钮选择一个图片文件(jpg/png/webp), **Then** 显示上传进度,完成后在左上预览区显示图片,支持缩放和拖拽
2. **Given** 用户选择一个 PDF 文件, **When** 上传完成, **Then** 预览区显示 PDF 内容,支持翻页、缩放、页码跳转
3. **Given** 用户选择一个 Office 文件(docx/xlsx/pptx), **When** 上传, **Then** 系统显示转换中提示,转换完成后以 PDF 格式预览
4. **Given** 用户上传文件超过大小限制(默认 200MB), **When** 上传开始, **Then** 系统立即提示错误,不执行上传
5. **Given** 用户上传不支持的文件类型, **When** 选择文件, **Then** 系统提示错误并列出支持的格式
6. **Given** Office 转换超时或失败, **When** 等待超过配置时间, **Then** 显示友好的错误消息,提供重试选项

---

### User Story 4 - 统一服务端 API 架构与错误处理 (Priority: P1)

作为开发者,我需要统一的服务端 API 架构,包括路由定义、请求处理、错误处理、日志记录,以便后续 AI 功能能够快速接入。

**Why this priority**: 统一的 API 架构是所有后端功能的基础。建立标准化的请求/响应格式、错误处理、日志记录机制,确保系统的可维护性和可扩展性。

**Independent Test**: 可通过以下方式独立测试:调用健康检查端点,上传测试文件,验证返回格式符合统一规范,触发各类错误场景,确认错误消息结构正确,检查日志文件包含完整的请求追踪信息。

**Acceptance Scenarios**:

1. **Given** 客户端调用任意 API 端点, **When** 请求成功, **Then** 返回格式为 `{ success: true, code: "OK", message: i18nKey, timestamp, traceId, data }`
2. **Given** 客户端调用 API 遇到验证错误, **When** 请求失败, **Then** 返回格式为 `{ success: false, code: "VALIDATION_ERROR", message: i18nKey, timestamp, traceId, details }`
3. **Given** 用户发起请求, **When** 系统处理请求, **Then** 生成唯一的 traceId,贯穿请求全生命周期,所有相关日志包含此 traceId
4. **Given** 系统处理请求过程中发生异常, **When** 捕获异常, **Then** 记录完整的错误堆栈到日志,返回用户友好的错误消息(不泄露内部细节)
5. **Given** 客户端请求头包含 `Accept-Language: zh-CN`, **When** 系统返回错误或成功消息, **Then** message 字段返回中文本地化文本
6. **Given** 系统运行, **When** 发生关键事件(上传、转换、处理开始/完成), **Then** 记录结构化 JSON 日志,包含时间戳、级别、事件类型、traceId、上下文信息

---

### User Story 5 - 模型配置与调用适配层 (Priority: P2)

作为系统维护人员,我需要通过配置文件管理多个 AI 模型,包括模型分类、连接参数、限流配置,以便系统能够灵活调用不同的模型服务。

**Why this priority**: 模型调用是 AI 功能的核心。建立统一的模型配置和调用层,支持 OpenAI 兼容接口,为后续 OCR、翻译、问答等功能提供基础设施。

**Independent Test**: 可通过以下方式独立测试:配置多个测试模型,通过配置文件切换模型,调用测试接口验证模型调用成功,测试超时和错误重试机制,验证限流功能正常工作。

**Acceptance Scenarios**:

1. **Given** 配置文件定义多个模型, **When** 系统启动, **Then** 成功加载所有模型配置,按类别(ocr/translate/qa/review/extract)分组
2. **Given** 配置包含模型的 API 端点和密钥, **When** 调用模型服务, **Then** 使用正确的端点和认证信息发送请求
3. **Given** 模型配置包含超时设置(如 180 秒), **When** 请求超过此时间, **Then** 自动取消请求,返回超时错误
4. **Given** 模型配置包含并发限制(如最多 5 个并发请求), **When** 同时发起 10 个请求, **Then** 前 5 个立即执行,后 5 个排队等待
5. **Given** 模型调用失败(网络错误、API 错误), **When** 发生错误, **Then** 记录详细错误日志(包含请求参数、响应码、错误消息),返回统一错误格式
6. **Given** 配置文件更新, **When** 执行配置重载命令, **Then** 系统重新加载配置,新请求使用新配置,无需重启服务

---

### User Story 6 - 文件存储与生命周期管理 (Priority: P2)

作为系统,我需要安全地存储上传的文件、转换结果、处理产物,并在配置的时间后自动清理,以避免磁盘空间耗尽。

**Why this priority**: 文件存储管理是系统稳定运行的保障。合理的存储结构和自动清理机制防止资源泄漏,确保系统长期可靠运行。

**Independent Test**: 可通过以下方式独立测试:上传文件后验证存储路径结构,等待 TTL 时间后确认文件被清理,测试磁盘配额限制,验证会话隔离机制。

**Acceptance Scenarios**:

1. **Given** 用户上传主文档, **When** 文件上传成功, **Then** 文件保存到 `/data/{sessionId}/uploads/` 目录,生成唯一文件 ID
2. **Given** Office 文件转换为 PDF, **When** 转换完成, **Then** PDF 文件保存到 `/data/{sessionId}/converted/` 目录
3. **Given** AI 处理生成结果, **When** 处理完成, **Then** 结果文件(JSON/Markdown)保存到 `/data/{sessionId}/results/` 目录
4. **Given** 文件创建时间超过配置的 TTL(如 24 小时), **When** 定时清理任务运行, **Then** 自动删除过期文件和空目录
5. **Given** 用户会话结束, **When** 会话过期, **Then** 该会话的所有文件被标记为可清理,在下次清理任务时删除
6. **Given** 磁盘使用接近配额限制, **When** 新文件上传, **Then** 系统拒绝上传并提示存储空间不足

---

### User Story 7 - 国际化(i18n)基础设施 (Priority: P2)

作为用户,我可以在中文和英文之间切换界面语言,所有文本、错误消息、日志都支持双语显示。

**Why this priority**: i18n 是全局性功能,影响所有用户界面和交互。早期建立完善的 i18n 机制,避免后期大规模重构。

**Independent Test**: 可通过以下方式独立测试:切换语言选项,验证所有界面元素(按钮、标签、提示、错误消息)使用正确语言,测试服务端根据请求语言返回本地化消息,检查日志文件包含 i18n key 和本地化文本。

**Acceptance Scenarios**:

1. **Given** 用户首次访问应用, **When** 页面加载, **Then** 根据浏览器语言自动选择中文或英文
2. **Given** 用户点击语言切换按钮, **When** 选择英文, **Then** 所有界面文本立即切换为英文,包括按钮、标签、提示、占位符
3. **Given** 用户执行操作触发错误, **When** 系统返回错误, **Then** 错误消息使用用户当前选择的语言
4. **Given** 客户端请求包含 `Accept-Language: en-US`, **When** 服务端返回响应, **Then** message 字段包含英文文本
5. **Given** 系统记录日志, **When** 写入日志条目, **Then** 日志包含 i18n key(如 `error.upload.failed`)和本地化消息
6. **Given** 开发者添加新界面文本, **When** 使用 i18n key, **Then** 中英文消息字典都包含对应翻译,编译时检查缺失的翻译

---

### User Story 8 - JS SDK 基础框架 (Priority: P3)

作为高级用户/集成方,我可以通过 JS SDK 以编程方式调用平台能力,无需使用 UI 界面,实现自动化批量处理。

**Why this priority**: SDK 扩展了平台的使用场景,支持高级用户和系统集成。虽然不是 MVP 必需,但建立基础框架为后续功能集成做准备。

**Independent Test**: 可通过以下方式独立测试:编写测试脚本,通过 SDK 初始化客户端,调用上传、查询等基础接口,验证返回格式与 API 一致,测试错误处理和超时机制。

**Acceptance Scenarios**:

1. **Given** 用户安装 SDK (`npm install @idealworld/ai-docs-sdk`), **When** 在 Node.js 或浏览器环境导入, **Then** 成功创建客户端实例
2. **Given** 用户调用 `sdk.uploadMain(file)`, **When** 上传完成, **Then** 返回 `{ success: true, data: { fileId, name, type } }`,格式与服务端 API 一致
3. **Given** 用户调用接口遇到错误, **When** 请求失败, **Then** SDK 抛出包含完整错误信息的异常,包括 code、message、traceId、details
4. **Given** 用户配置超时时间, **When** 请求超过超时时间, **Then** SDK 自动取消请求,抛出超时错误
5. **Given** SDK 文档站点, **When** 用户访问, **Then** 提供完整的 API 文档、使用示例、错误码说明
6. **Given** SDK 版本更新, **When** 发布新版本, **Then** 保持向后兼容,或在主版本升级时提供清晰的迁移指南

---

### Edge Cases

- **大文件处理**: 当用户上传接近 200MB 限制的文件时,系统如何优雅地处理上传进度、内存占用、超时?
- **并发上传**: 当用户同时上传多个文件时,系统如何处理并发请求、资源竞争、错误隔离?
- **网络中断**: 当上传或转换过程中网络中断时,系统能否恢复或提供重试机制?
- **Office 转换失败**: 当 LibreOffice 无法转换损坏的 Office 文件时,如何给用户清晰的错误提示?
- **磁盘空间不足**: 当服务器磁盘空间不足时,系统如何提前预警并拒绝新上传?
- **模型 API 不可用**: 当配置的模型服务全部不可用时,系统如何降级或通知用户?
- **会话过期**: 当用户长时间未操作导致会话过期时,如何保护数据并引导用户重新开始?
- **浏览器兼容性**: 当用户使用不支持的旧版浏览器时,如何检测并提示升级?
- **配置文件错误**: 当管理员编辑配置文件引入语法错误时,系统能否检测并拒绝加载无效配置?
- **时区差异**: 当用户和服务器位于不同时区时,时间戳显示是否正确?

## Requirements _(mandatory)_

### Functional Requirements

#### 项目架构与开发环境

- **FR-001**: 系统必须使用 SvelteKit (Svelte 5) 作为前端框架
- **FR-002**: 系统必须集成 FlyonUI 和 Tailwind CSS v4 用于 UI 组件和样式
- **FR-003**: 系统必须使用 pnpm 作为包管理器
- **FR-004**: 系统必须支持开发模式热更新(HMR)
- **FR-005**: 系统必须提供生产环境构建命令,生成优化的静态资源
- **FR-006**: 系统必须配置代码检查工具(ESLint)和格式化工具(Prettier)

#### 基础 UI 组件与布局

- **FR-007**: 系统必须提供可拖拽调整的分栏布局组件(左右分栏,左侧上下分栏)
- **FR-008**: 系统必须提供基础按钮组件,支持多种变体(主要、次要、危险、禁用、加载中)
- **FR-009**: 系统必须提供卡片组件,支持标题、内容、操作区、展开/折叠
- **FR-010**: 系统必须提供进度条组件,支持百分比显示和动画更新
- **FR-011**: 系统必须提供模态对话框组件,支持确认/取消/自定义操作
- **FR-012**: 系统必须提供下拉菜单组件,支持单选、多选、搜索
- **FR-013**: 系统必须提供表单组件(输入框、文本域、选择器、复选框、单选框)
- **FR-014**: 系统必须提供通知/消息提示组件(成功、错误、警告、信息)
- **FR-015**: 所有组件必须支持响应式设计,适配桌面和移动设备

#### 文件上传与预览

- **FR-016**: 系统必须支持上传图片文件(png、jpg、webp),大小不超过 200MB(可配置)
- **FR-017**: 系统必须支持上传 PDF 文件,大小不超过 200MB(可配置)
- **FR-018**: 系统必须支持上传 Office 文件(docx、xlsx、pptx),大小不超过 200MB(可配置)
- **FR-019**: 系统必须在上传过程中显示实时进度条
- **FR-020**: 系统必须验证文件类型和大小,在上传前拒绝无效文件
- **FR-021**: 系统必须在图片上传后提供预览功能,支持缩放(放大/缩小)和拖拽
- **FR-022**: 系统必须在 PDF 上传后提供预览功能,支持翻页、缩放、页码跳转
- **FR-023**: 系统必须自动将 Office 文件转换为 PDF 以供预览
- **FR-024**: Office 转换必须在服务端使用 LibreOffice headless 模式执行
- **FR-025**: 系统必须在转换过程中显示进度提示
- **FR-026**: 转换任务超过配置时间(默认 120 秒)必须超时并报错
- **FR-027**: 系统必须在预览区支持高亮指定区域(为 OCR 结果联动准备)

#### 服务端 API 架构

- **FR-028**: 所有 API 成功响应必须遵循统一格式: `{ success: true, code: "OK", message: i18nKey, timestamp, traceId, data }`
- **FR-029**: 所有 API 错误响应必须遵循统一格式: `{ success: false, code, message: i18nKey, timestamp, traceId, details? }`
- **FR-030**: 系统必须为每个请求生成唯一 traceId,用于全链路日志追踪
- **FR-031**: 系统必须提供文件上传端点 `POST /api/upload`,接收主文档
- **FR-032**: 系统必须提供附加文档上传端点 `POST /api/attachments`
- **FR-033**: 系统必须提供任务查询端点 `GET /api/task/:id`,返回任务状态和进度
- **FR-034**: 系统必须提供健康检查端点 `GET /api/health`,返回服务状态
- **FR-035**: 系统必须捕获所有未处理异常,返回统一错误格式,避免泄露内部细节
- **FR-036**: 系统必须根据请求的 `Accept-Language` 头返回本地化错误消息
- **FR-037**: 系统必须记录所有请求的结构化日志,包含 traceId、请求参数、响应状态、耗时

#### 日志记录

- **FR-038**: 系统必须使用 JSON 格式记录日志
- **FR-039**: 每条日志必须包含: 时间戳(ISO8601)、级别(info/warn/error)、事件类型、traceId、上下文信息
- **FR-040**: 错误日志必须包含完整的错误堆栈
- **FR-041**: 系统必须记录关键事件: upload、convert.start、convert.done、cleanup.run
- **FR-042**: 日志必须写入文件,支持按日期滚动和自动清理

#### 模型配置与调用

- **FR-043**: 系统必须支持通过 YAML 配置文件定义多个 AI 模型
- **FR-044**: 模型配置必须包含: 模型 ID、名称、类别(ocr/translate/qa/review/extract)、API 端点、认证信息、超时、并发限制
- **FR-045**: 系统必须支持从环境变量读取模型 API 密钥,不允许密钥硬编码到配置文件
- **FR-046**: 系统必须实现模型调用适配层,统一调用 OpenAI 兼容接口
- **FR-047**: 系统必须支持为每个模型配置独立的超时时间(默认 180 秒)
- **FR-048**: 系统必须支持为每个模型类别配置并发限制(默认 5 个并发)
- **FR-049**: 超过并发限制的请求必须排队等待,提供队列位置信息
- **FR-050**: 模型调用失败必须记录详细日志(请求参数、响应码、错误消息),返回统一错误格式
- **FR-051**: 系统必须支持运行时重载模型配置,无需重启服务

#### 文件存储与生命周期

- **FR-052**: 系统必须使用本地文件系统存储文件,路径结构为 `/data/{sessionId}/{category}/`
- **FR-053**: 上传的原始文件必须保存到 `uploads/` 子目录
- **FR-054**: 转换后的 PDF 必须保存到 `converted/` 子目录
- **FR-055**: AI 处理结果必须保存到 `results/` 子目录
- **FR-056**: 每个文件必须生成唯一 ID(UUID),并记录元数据(名称、类型、大小、创建时间、会话 ID)
- **FR-057**: 系统必须支持配置文件 TTL(默认 24 小时)
- **FR-058**: 系统必须提供定时清理任务,自动删除超过 TTL 的文件
- **FR-059**: 清理任务必须同时删除空目录
- **FR-060**: 系统必须支持配置磁盘配额,拒绝超过配额的上传

#### 国际化(i18n)

- **FR-061**: 系统必须支持中文(zh-CN)和英文(en-US)双语
- **FR-062**: 所有 UI 文本必须使用 i18n key,不允许硬编码文本
- **FR-063**: 系统必须根据浏览器语言自动选择默认语言
- **FR-064**: 用户必须能够手动切换语言,切换后立即生效
- **FR-065**: 语言选择必须持久化(localStorage),刷新后保持
- **FR-066**: 服务端错误消息必须根据 `Accept-Language` 头返回对应语言
- **FR-067**: 日志记录必须同时包含 i18n key 和本地化消息
- **FR-068**: 开发模式必须检查缺失的翻译,在控制台输出警告

#### JS SDK

- **FR-069**: 系统必须提供 npm 包 `@idealworld/ai-docs-sdk`
- **FR-070**: SDK 必须支持 Node.js 和浏览器环境
- **FR-071**: SDK 必须提供客户端初始化方法,接收 baseUrl 和可选的 apiKey
- **FR-072**: SDK 必须提供文件上传方法,返回 Promise,解析为 `{ fileId, name, type }`
- **FR-073**: SDK 所有方法返回必须遵循服务端统一响应格式
- **FR-074**: SDK 必须支持配置超时时间,超时自动取消请求
- **FR-075**: SDK 错误必须包含 code、message、traceId、details
- **FR-076**: SDK 必须提供 TypeScript 类型定义

### Key Entities

- **Session(会话)**: 代表一个用户交互会话,包含唯一 ID、创建时间、过期时间、语言偏好、关联的文件列表
- **File(文件)**: 代表上传或生成的文件,包含唯一 ID、文件名、类型(image/pdf/office)、大小、存储路径、创建时间、所属会话 ID、元数据(页数、尺寸等)
- **Task(任务)**: 代表长时间运行的异步任务(如 Office 转换),包含唯一 ID、类型、状态(pending/running/succeeded/failed)、进度(0-100)、阶段描述、预计完成时间、结果引用、错误信息
- **Model(模型)**: 代表 AI 模型配置,包含唯一 ID、名称、类别、API 端点、超时配置、并发限制、状态(可用/不可用)
- **LogEntry(日志条目)**: 代表一条结构化日志,包含时间戳、级别、事件类型、traceId、会话 ID、文件 ID、消息 key、本地化消息、上下文数据、错误堆栈

## Success Criteria _(mandatory)_

### Measurable Outcomes

- **SC-001**: 开发者能够在 5 分钟内完成项目初始化,启动开发服务器,看到默认页面
- **SC-002**: 前端代码修改后,页面在 1 秒内自动热更新,反映最新变更
- **SC-003**: 用户切换语言后,所有界面文本在 200 毫秒内切换完成,无闪烁或延迟
- **SC-004**: 用户上传 50MB 的文件,系统在 30 秒内完成上传并显示预览(网络速度 10Mbps)
- **SC-005**: 用户上传 Office 文件,系统在 60 秒内完成转换并显示 PDF 预览(10 页文档)
- **SC-006**: 所有 API 响应包含完整的 traceId,日志文件中可通过 traceId 追踪完整请求链路
- **SC-007**: 模型调用超时后,用户在 5 秒内收到友好的错误提示,不影响其他功能使用
- **SC-008**: 系统能够同时处理 10 个文件上传请求,每个请求独立处理,互不影响
- **SC-009**: 文件清理任务每小时运行一次,准确删除超过 TTL 的文件,清理后磁盘占用减少至预期水平
- **SC-010**: SDK 用户能够在 10 分钟内阅读文档,编写测试脚本,成功调用上传接口并获得文件 ID
- **SC-011**: 基础组件库包含至少 10 个可复用组件,每个组件有清晰的 API 文档和使用示例
- **SC-012**: 系统在 Chrome、Firefox、Safari、Edge 最新版本中正常运行,无功能或样式问题
- **SC-013**: 错误日志包含足够的上下文信息(traceId、请求参数、错误堆栈),开发者能够在 5 分钟内定位问题根源
- **SC-014**: 配置文件更新后,系统在 10 秒内重载配置,新请求使用新配置,无需重启服务
